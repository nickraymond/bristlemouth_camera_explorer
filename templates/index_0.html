<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bristlemouth Camera Explorer</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='BM_logo.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --thumb-size: 240px;
        }
        body {
            font-family: 'Inter', sans-serif;
            font-size: 16px;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            background: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        header img {
            height: 40px;
            margin-right: 1rem;
        }
        h1 {
            font-weight: 600;
            font-size: 1.5rem;
            color: #222;
        }
        .container {
            display: flex;
            flex: 1;
            height: calc(100% - 80px);
            padding: 1rem;
            gap: 1rem;
        }
        .sidebar {
            min-width: 320px;
            max-width: 400px;
            background: #fff;
            padding: 1.5rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            box-sizing: border-box;
            border-radius: 8px;
            flex-shrink: 0;
        }
        .content {
            flex: 1;
            background: #fff;
            padding: 1.5rem;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        form label {
            display: block;
            margin-top: 1rem;
            font-weight: 600;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }
        input[type="submit"], .btn-clear {
            background-color: #ff6600;
            color: white;
            font-weight: 600;
            border: none;
            margin-top: 1.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 0.6rem 1rem;
        }
        input[type="submit"]:hover, .btn-clear:hover {
            background-color: #e05d00;
        }
        .btn-clear {
            background-color: #999;
            margin-left: 0.5rem;
        }
        .image-group {
            margin-bottom: 2rem;
        }
        .node-title {
            font-weight: 600;
            margin: 1rem 0 0.5rem;
            color: #444;
        }
        .image-tile {
            display: inline-block;
            margin: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .image-tile img {
            max-width: var(--thumb-size);
            height: auto;
            border-radius: 3px;
            cursor: pointer;
        }
        .image-tile small {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.8rem;
            color: #666;
        }
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .fullscreen img {
            max-width: 90vw;
            max-height: 90vh;
        }
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            color: white;
            cursor: pointer;
            padding: 1rem;
            z-index: 1001;
        }
        .nav-arrow.left {
            left: 20px;
        }
        .nav-arrow.right {
            right: 20px;
        }
        #thumb-slider {
            margin-bottom: 1rem;
            width: 200px;
        }
    </style>
</head>
<body>
    <header>
        <img src="{{ url_for('static', filename='BM_logo.png') }}" alt="BM Logo">
        <h1>Bristlemouth Camera Explorer</h1>
    </header>

    <div class="container">
        <div class="sidebar">
            <form method="POST">
                <label for="spotter">SPOT ID:</label>
                <input type="text" name="spotter" value="{{ request.form.get('spotter', '') }}" placeholder="e.g. SPOT-32071C" required>

                <label for="token">API Token:</label>
                <input type="text" name="token" value="{{ request.form.get('token', '') }}" placeholder="Your API token" required>

                <label for="start">Start Date:</label>
                <input type="datetime-local" name="start" value="{{ request.form.get('start', '') }}" required>

                <label for="end">End Date:</label>
                <input type="datetime-local" name="end" value="{{ request.form.get('end', '') }}" required>

                <input type="submit" value="Fetch Images">
                <button type="button" class="btn-clear" onclick="clearInputs()">Clear Results</button>

                <label for="thumb-slider">Thumbnail Size</label>
                <input id="thumb-slider" type="range" min="100" max="400" value="240" oninput="document.documentElement.style.setProperty('--thumb-size', this.value + 'px')">
            </form>
        </div>

        <div class="content">
            {% if images_grouped %}
                {% for spot_id, node_dict in images_grouped.items() %}
                    <div class="image-group">
                        <h2>Spot ID: {{ spot_id }}</h2>
                        {% for node_id, images in node_dict.items() %}
                            <h3 class="node-title">Node ID: {{ node_id }}</h3>
                            {% for img in images %}
                                <div class="image-tile">
                                    <img src="{{ url_for('serve_image', filename=img.path) }}" alt="Image"
                                         onclick="showFullscreen({{ loop.index0 }}, '{{ img.path }}')"
                                         data-lat="{{ img.lat }}" data-lon="{{ img.lon }}">
                                    <small>{{ img.path.split('/')[-1] }}</small>
                                    <small><a href="{{ url_for('serve_image', filename=img.path) }}" download>Download</a></small>
                                    <small>
                                      <a href="https://www.google.com/maps?q={{ img.lat }},{{ img.lon }}" target="_blank">
                                        Lat: {{ img.lat }}, Lon: {{ img.lon }}
                                      </a>
                                    </small>

                                </div>
                            {% endfor %}
                        {% endfor %}
                    </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>

    <div id="fullscreen-view" class="fullscreen" style="display:none;" onclick="hideFullscreen()">
        <div id="fullscreen-info" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); color: white; font-size: 1rem; font-weight: 600;"></div>
        <div class="nav-arrow left" onclick="navigateImage(-1, event)">&#10094;</div>
        <img id="fullscreen-img" src="" alt="Fullscreen Image">
        <div class="nav-arrow right" onclick="navigateImage(1, event)">&#10095;</div>
        <div style="position: absolute; bottom: 20px; right: 20px;">
            <a id="fullscreen-download" href="#" download style="color: white; margin-right: 1rem; text-decoration: none; font-weight: 600;">Download</a>
            <a id="fullscreen-map" href="#" target="_blank" style="color: white; text-decoration: none; font-weight: 600;">View on map</a>
        </div>
    </div>

    <script>
        function clearInputs() {
            document.querySelector('input[name=spotter]').value = '';
            document.querySelector('input[name=token]').value = '';
            document.querySelector('input[name=start]').value = '';
            document.querySelector('input[name=end]').value = '';
            document.querySelector('.content').innerHTML = '';
            document.documentElement.style.setProperty('--thumb-size', '240px');
        }

        const images = Array.from(document.querySelectorAll('.image-tile img'));
        let currentImageIndex = 0;

        function showFullscreen(index, src) {
            currentImageIndex = index_0;
            const viewer = document.getElementById('fullscreen-view');
            const img = document.getElementById('fullscreen-img');
            const info = document.getElementById('fullscreen-info');
            const downloadLink = document.getElementById('fullscreen-download');
            const mapLink = document.getElementById('fullscreen-map');
            const fileName = src.split('/').pop();

            img.src = src;
            info.textContent = fileName;
            downloadLink.href = src;

            const lat = img.dataset.lat;
            const lon = img.dataset.lon;
            if (lat && lon) {
                mapLink.href = `https://www.google.com/maps?q=${lat},${lon}`;
            } else {
                mapLink.href = '#';
            }
            viewer.style.display = 'flex';
        }

        function hideFullscreen() {
            document.getElementById('fullscreen-view').style.display = 'none';
        }

        function navigateImage(direction, event) {
            event.stopPropagation();
            currentImageIndex += direction;
            if (currentImageIndex < 0) currentImageIndex = 0;
            if (currentImageIndex >= images.length) currentImageIndex = images.length - 1;
            const img = document.getElementById('fullscreen-img');
            img.src = images[currentImageIndex].src;
        }

        document.addEventListener('keydown', function(e) {
            if (document.getElementById('fullscreen-view').style.display === 'flex') {
                if (e.key === 'ArrowLeft') navigateImage(-1, e);
                if (e.key === 'ArrowRight') navigateImage(1, e);
                if (e.key === 'Escape') hideFullscreen();
            }
        });
    </script>
</body>
</html>
